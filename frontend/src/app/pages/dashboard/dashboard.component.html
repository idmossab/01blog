<div class="dashboard-wrap">
  <section class="dashboard-card" *ngIf="!loading; else loadingState">
    <header class="dashboard-head">
      <h2>Admin Dashboard</h2>
      <p>Manage users, blogs, and reports</p>
    </header>

    <nav class="tabs">
      <button type="button" [class.active]="tab === 'users'" (click)="tab = 'users'">
        Users ({{ users.length }})
      </button>
      <button type="button" [class.active]="tab === 'posts'" (click)="tab = 'posts'">
        Blogs ({{ posts.length }})
      </button>
      <button type="button" [class.active]="tab === 'reports'" (click)="tab = 'reports'">
        Reports ({{ reportsCount }})
      </button>
    </nav>

    <section *ngIf="tab === 'users'" class="panel">
      <input
        class="search"
        type="text"
        [(ngModel)]="search"
        placeholder="Search users by name or email..."
      />

      <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Blogs</th>
            <th>Followers</th>
            <th>Role</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredUsers">
            <td data-label="User">
              <button class="user-link" type="button" (click)="openProfile(item.userId)">
                {{ item.userName }}
              </button>
            </td>
            <td data-label="Email">{{ item.email }}</td>
            <td data-label="Blogs">{{ userPostsCount[item.userId] || 0 }}</td>
            <td data-label="Followers">{{ followerCountByUser[item.userId] || 0 }}</td>
            <td data-label="Role">
              <button
                class="badge role-action"
                type="button"
                [class.admin]="item.role === 'ADMIN'"
                [disabled]="!canChangeRole(item)"
                (click)="toggleUserRole(item)"
              >
                {{ item.role === 'ADMIN' ? 'Admin' : 'User' }}
              </button>
            </td>
            <td data-label="Status">
              <span class="badge" [class.active-status]="item.status === 'ACTIVE'" [class.banned]="item.status === 'BANNED'">
                {{ item.status }}
              </span>
            </td>
            <td class="actions-cell" data-label="Actions">
              <button
                class="action"
                type="button"
                (click)="toggleUserStatus(item)"
                [disabled]="item.role === 'ADMIN' || item.userId === user?.userId"
              >
                {{ item.status === 'BANNED' ? 'Unban' : 'Ban' }}
              </button>
              <button
                class="action delete-action"
                type="button"
                (click)="openDeleteUserModal(item)"
                [disabled]="item.role === 'ADMIN' || item.userId === user?.userId"
              >
                Delete
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      </div>
    </section>

    <section *ngIf="tab === 'posts'" class="panel">
      <div class="post-filter-row">
        <select class="post-filter" [(ngModel)]="postAuthorFilter">
          <option value="ALL">All users</option>
          <option *ngFor="let option of postAuthorFilters" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Blog Title</th>
            <th>Author</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let post of filteredPosts">
            <td data-label="Blog Title">
              <button class="blog-link" type="button" (click)="openBlog(post.idBlog)">
                {{ post.title }}
              </button>
            </td>
            <td data-label="Author">{{ post.userName || 'Unknown' }}</td>
            <td data-label="Status">
              <button
                class="badge role-action"
                type="button"
                [class.active-status]="post.status === 'ACTIVE'"
                [class.hidden-status]="post.status === 'HIDDEN'"
                (click)="togglePostStatus(post)"
              >
                {{ post.status === 'HIDDEN' ? 'HIDDEN' : 'ACTIVE' }}
              </button>
            </td>
            <td class="actions-cell" data-label="Actions">
              <button class="action delete-action" type="button" (click)="openDeletePostModal(post)">
                Delete
              </button>
            </td>
          </tr>
          <tr *ngIf="!filteredPosts.length">
            <td colspan="4">No blogs found.</td>
          </tr>
        </tbody>
      </table>
      </div>
    </section>

    <section *ngIf="tab === 'reports'" class="panel">
      <div class="report-filter-row">
        <select class="report-filter" [(ngModel)]="reportReasonFilter">
          <option value="ALL">All reasons</option>
          <option *ngFor="let reason of reportReasonOptions" [value]="reason.value">{{ reason.label }}</option>
        </select>
      </div>

      <div class="report-list">
        <article class="report-item" *ngFor="let report of filteredReports">
          <div class="report-top">
            <span class="reason-pill">{{ formatReason(report.reason) }}</span>
            <div class="report-top-actions" *ngIf="report.blogId">
              <button
                class="action"
                type="button"
                (click)="openBlog(report.blogId)"
              >
                View Blog
              </button>
              <button
                class="action delete-action"
                type="button"
                (click)="deleteReportedPost(report)"
              >
                Delete Blog
              </button>
            </div>
          </div>

          <div class="report-meta">
            Reported by {{ report.reporterUserName || 'unknown' }}
            <span *ngIf="report.createdAt"> â€¢ {{ report.createdAt | date:'medium' }}</span>
          </div>

          <div class="report-content-card" *ngIf="report.blogId; else userReportContent">
            <button class="blog-link report-blog-link" type="button" (click)="openBlog(report.blogId)">
              {{ report.blogTitle || 'Open blog details' }}
            </button>
            <div class="report-author">{{ report.blogAuthorUserName || 'unknown user' }}</div>
            <div class="report-content">{{ report.blogContent || report.details || '-' }}</div>
          </div>
          <ng-template #userReportContent>
            <div class="report-content-card">
              <div class="report-author">User report: {{ report.reportedUserName || 'unknown user' }}</div>
              <div class="report-content">{{ report.details || '-' }}</div>
            </div>
          </ng-template>
        </article>
        <div class="text-muted" *ngIf="!filteredReports.length">No reports found.</div>
      </div>
    </section>

    <div class="error" *ngIf="error">{{ error }}</div>
  </section>
</div>

<ng-template #loadingState>
  <div class="dashboard-card">
    <div class="loading">Loading dashboard...</div>
  </div>
</ng-template>

<div class="confirm-overlay" *ngIf="confirmActionType">
  <div class="confirm-card">
    <h5>{{ confirmTitle }}</h5>
    <p>{{ confirmMessage }}</p>
    <div class="confirm-actions">
      <button
        class="action"
        [class.delete-action]="confirmDanger"
        type="button"
        (click)="confirmAdminAction()"
        [disabled]="confirmActionLoading"
      >
        {{ confirmActionLoading ? 'Processing...' : confirmButtonText }}
      </button>
      <button class="action" type="button" (click)="closeConfirmModal()" [disabled]="confirmActionLoading">
        Cancel
      </button>
    </div>
  </div>
</div>
