<div class="dashboard-wrap">
  <section class="dashboard-card" *ngIf="!loading; else loadingState">
    <header class="dashboard-head">
      <h2>Admin Dashboard</h2>
      <p>Manage users, posts, and reports</p>
    </header>

    <nav class="tabs">
      <button type="button" [class.active]="tab === 'users'" (click)="tab = 'users'">
        Users ({{ users.length }})
      </button>
      <button type="button" [class.active]="tab === 'posts'" (click)="tab = 'posts'">
        Posts ({{ posts.length }})
      </button>
      <button type="button" [class.active]="tab === 'reports'" (click)="tab = 'reports'">
        Reports ({{ reportsCount }})
      </button>
    </nav>

    <section *ngIf="tab === 'users'" class="panel">
      <input
        class="search"
        type="text"
        [(ngModel)]="search"
        placeholder="Search users by name or email..."
      />

      <table class="table">
        <thead>
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Posts</th>
            <th>Followers</th>
            <th>Role</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredUsers">
            <td>
              <button class="user-link" type="button" (click)="openProfile(item.userId)">
                {{ item.userName }}
              </button>
            </td>
            <td>{{ item.email }}</td>
            <td>{{ userPostsCount[item.userId] || 0 }}</td>
            <td>{{ followerCountByUser[item.userId] || 0 }}</td>
            <td>
              <button
                class="badge role-action"
                type="button"
                [class.admin]="item.role === 'ADMIN'"
                [disabled]="!canChangeRole(item)"
                (click)="toggleUserRole(item)"
              >
                {{ item.role === 'ADMIN' ? 'Admin' : 'User' }}
              </button>
            </td>
            <td>
              <span class="badge" [class.active-status]="item.status === 'ACTIVE'" [class.banned]="item.status === 'BANNED'">
                {{ item.status }}
              </span>
            </td>
            <td>
              <button
                class="action"
                type="button"
                (click)="toggleUserStatus(item)"
                [disabled]="item.role === 'ADMIN' || item.userId === user?.userId"
              >
                {{ item.status === 'BANNED' ? 'Unban' : 'Ban' }}
              </button>
              <button
                class="action delete-action"
                type="button"
                (click)="openDeleteUserModal(item)"
                [disabled]="item.role === 'ADMIN' || item.userId === user?.userId"
              >
                Delete
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <section *ngIf="tab === 'posts'" class="panel">
      <table class="table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let post of posts">
            <td>{{ post.title }}</td>
            <td>{{ post.userName || 'Unknown' }}</td>
            <td>
              <button
                class="badge role-action"
                type="button"
                [class.active-status]="post.status === 'ACTIVE'"
                [class.hidden-status]="post.status === 'HIDDEN'"
                (click)="togglePostStatus(post)"
              >
                {{ post.status === 'HIDDEN' ? 'HIDDEN' : 'ACTIVE' }}
              </button>
            </td>
            <td>
              <button class="action delete-action" type="button" (click)="openDeletePostModal(post)">
                Delete
              </button>
            </td>
          </tr>
          <tr *ngIf="!posts.length">
            <td colspan="4">No posts found.</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section *ngIf="tab === 'reports'" class="panel">
      <div class="report-filter-row">
        <select class="report-filter" [(ngModel)]="reportReasonFilter">
          <option value="ALL">All reasons</option>
          <option *ngFor="let reason of reportReasonOptions" [value]="reason.value">{{ reason.label }}</option>
        </select>
      </div>

      <div class="report-list">
        <article class="report-item" *ngFor="let report of filteredReports">
          <div class="report-top">
            <span class="reason-pill">{{ formatReason(report.reason) }}</span>
            <button
              class="action delete-action"
              type="button"
              *ngIf="report.blogId"
              (click)="deleteReportedPost(report)"
            >
              Delete Post
            </button>
          </div>

          <div class="report-meta">
            Reported by {{ report.reporterUserName || 'unknown' }}
            <span *ngIf="report.createdAt"> â€¢ {{ report.createdAt | date:'medium' }}</span>
          </div>

          <div class="report-content-card" *ngIf="report.blogId; else userReportContent">
            <div class="report-author">{{ report.blogAuthorUserName || 'unknown user' }}</div>
            <div class="report-content">{{ report.blogContent || report.details || '-' }}</div>
          </div>
          <ng-template #userReportContent>
            <div class="report-content-card">
              <div class="report-author">User report: {{ report.reportedUserName || 'unknown user' }}</div>
              <div class="report-content">{{ report.details || '-' }}</div>
            </div>
          </ng-template>
        </article>
        <div class="text-muted" *ngIf="!filteredReports.length">No reports found.</div>
      </div>
    </section>

    <div class="error" *ngIf="error">{{ error }}</div>
  </section>
</div>

<ng-template #loadingState>
  <div class="dashboard-card">
    <div class="loading">Loading dashboard...</div>
  </div>
</ng-template>

<div class="confirm-overlay" *ngIf="pendingDeleteUser">
  <div class="confirm-card">
    <h5>Delete User</h5>
    <p>
      Are you sure you want to delete
      <strong>{{ pendingDeleteUser.userName }}</strong>?
      This action cannot be undone.
    </p>
    <div class="confirm-actions">
      <button class="action delete-action" type="button" (click)="confirmDeleteUser()" [disabled]="deleteUserLoading">
        {{ deleteUserLoading ? 'Deleting...' : 'Yes, Delete' }}
      </button>
      <button class="action" type="button" (click)="closeDeleteUserModal()" [disabled]="deleteUserLoading">
        Cancel
      </button>
    </div>
  </div>
</div>

<div class="confirm-overlay" *ngIf="pendingDeletePost">
  <div class="confirm-card">
    <h5>Delete Post</h5>
    <p>
      Are you sure you want to delete
      <strong>{{ pendingDeletePost.title }}</strong>?
      This action cannot be undone.
    </p>
    <div class="confirm-actions">
      <button class="action delete-action" type="button" (click)="confirmDeletePost()" [disabled]="deletePostLoading">
        {{ deletePostLoading ? 'Deleting...' : 'Yes, Delete' }}
      </button>
      <button class="action" type="button" (click)="closeDeletePostModal()" [disabled]="deletePostLoading">
        Cancel
      </button>
    </div>
  </div>
</div>
