<div class="container py-4" *ngIf="blog; else loadingState">
  <div class="details-card shadow-sm">
    <div class="details-header">
      <div>
        <h2 class="details-title">{{ blog.title }}</h2>
        <div class="details-meta">
          <span class="author">{{ blog.user?.firstName || user?.firstName }} {{ blog.user?.lastName || user?.lastName }}</span>
          <span class="dot">•</span>
          <span>{{ formatRelative(blog.createdAt) }}</span>
        </div>
      </div>
      <div class="details-actions">
        <button class="like-btn" type="button" (click)="toggleLike()" [class.liked]="liked">
          Like ({{ likeCount }})
        </button>
        <button class="report-btn" type="button" *ngIf="canReport()" (click)="openReportModal()">
          Report
        </button>
      </div>
    </div>

    <div class="details-content">{{ blog.content }}</div>

    <div class="media-gallery" *ngIf="media.length">
      <div class="media-main">
        <img
          *ngIf="media[selectedMediaIndex]?.mediaType?.startsWith('image')"
          [src]="media[selectedMediaIndex]?.url"
          alt="media"
          loading="lazy"
        />
        <video
          *ngIf="media[selectedMediaIndex]?.mediaType?.startsWith('video')"
          [src]="media[selectedMediaIndex]?.url"
          controls
          muted
        ></video>
      </div>
      <div class="media-thumbs">
        <button
          class="thumb"
          type="button"
          *ngFor="let item of media; let i = index"
          (click)="selectMedia(i)"
          [class.active]="i === selectedMediaIndex"
        >
          <img *ngIf="item.mediaType?.startsWith('image')" [src]="item.url" alt="thumb" loading="lazy" />
          <div class="video-thumb" *ngIf="item.mediaType?.startsWith('video')">
            <video [src]="item.url" muted playsinline></video>
            <div class="play-badge">▶</div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <div class="comments-card shadow-sm">
    <div class="comments-header">
      <h5>Comments ({{ blog.commentCount || 0 }})</h5>
    </div>
    <div class="comment-form">
      <textarea
        class="form-control"
        rows="3"
        [(ngModel)]="newComment"
        placeholder="Write a comment..."
      ></textarea>
      <button class="btn btn-dark" type="button" (click)="submitComment()">Post Comment</button>
    </div>
    <div class="comment-list">
      <div class="comment-item" *ngFor="let comment of comments">
        <div class="comment-meta">
          <span class="comment-author">
            {{ comment.user?.firstName }} {{ comment.user?.lastName }}
          </span>
          <span class="dot">•</span>
          <span>{{ formatRelative(comment.createdAt) }}</span>
        </div>
        <div class="comment-text">{{ comment.content }}</div>
      </div>
      <div class="text-muted" *ngIf="!comments.length">No comments yet.</div>
    </div>
  </div>

  <div class="alert alert-danger mt-3" *ngIf="error">{{ error }}</div>
  <div class="alert alert-success mt-3" *ngIf="reportSuccess">{{ reportSuccess }}</div>
</div>

<div class="report-overlay" *ngIf="reportModalOpen">
  <div class="report-modal shadow-sm">
    <h5 class="mb-3">Report Post</h5>

    <div class="mb-2">
      <label class="form-label">Report reason</label>
      <select class="form-select" [(ngModel)]="selectedReportReason">
        <option [ngValue]="''">Select a reason</option>
        <option *ngFor="let reason of reportReasons" [ngValue]="reason.value">{{ reason.label }}</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Additional details</label>
      <textarea
        class="form-control"
        rows="4"
        maxlength="500"
        [(ngModel)]="reportDetails"
        placeholder="Optional details (max 500 chars)"
      ></textarea>
      <div class="text-muted small mt-1">{{ reportDetails.length }}/500</div>
    </div>

    <div class="alert alert-danger py-2" *ngIf="reportError">{{ reportError }}</div>

    <div class="report-actions">
      <button class="btn btn-dark" type="button" (click)="submitReport()" [disabled]="reportSubmitting">
        {{ reportSubmitting ? 'Submitting...' : 'Submit' }}
      </button>
      <button class="btn btn-outline-secondary" type="button" (click)="closeReportModal()" [disabled]="reportSubmitting">
        Cancel
      </button>
    </div>
  </div>
</div>

<ng-template #loadingState>
  <div class="container py-4">
    <div class="text-muted">Loading blog...</div>
    <div class="alert alert-danger mt-3" *ngIf="error">{{ error }}</div>
  </div>
</ng-template>
